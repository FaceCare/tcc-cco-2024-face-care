---
- name: Wait for connection to be available and install Docker
  hosts: all
  vars:
    ansible_connection: aws_ssm
    ansible_aws_ssm_bucket_name: ansible-tcc
    ansible_aws_ssm_region: us-east-1
  tasks:
    - name: Wait for connection
      wait_for_connection:

    - name: Deploy modelo
      become: true
      become_user: root
      shell: |
        cd ~/tcc/tcc-cco-2024-face-care/
        git checkout dev
        git pull
        cd machine_learning/model/
        python3 -m pip install --upgrade pip
        python3 -m pip install -r requirements.txt
      ignore_errors: yes

    - name: Add cronjob to run model_train_v1.py every 5 minutes
      cron:
        name: "Run app.py every 1 hour"
        minute: "0"
        job: "cd ~/tcc/tcc-cco-2024-face-care/machine_learning/model/ && python3 model_train_v1.py"
        state: present
